{% extends "base_mobile.html" %}

{% block content %}
<!-- Search Bar -->
<div class="search-bar-mobile">
    <form action="/search" method="get" class="d-flex">
        <input type="text" name="q" class="form-control form-control-mobile" placeholder="Search products..." value="{{ query if query else '' }}">
        <button type="submit" class="btn btn-primary btn-mobile-sm ms-2">
            <i class="fas fa-search"></i>
        </button>
    </form>
</div>

<!-- Category Filter -->
<div class="mobile-card">
    <div class="swipe-section">
        <a href="{{ url_for('products') }}" class="btn {% if not selected_category %}btn-primary{% else %}btn-outline-primary{% endif %} swipe-item">
            All
        </a>
        {% for category in categories %}
        <a href="{{ url_for('products') }}?category={{ category }}" class="btn {% if selected_category == category %}btn-primary{% else %}btn-outline-primary{% endif %} swipe-item">
            {{ category }}
        </a>
        {% endfor %}
    </div>
</div>

<!-- Products Grid -->
<div class="products-container-mobile">
    {% if products %}
    <div class="products-grid-mobile">
        {% for product in products %}
        <div class="product-card-mobile">
            <button class="wishlist-btn-mobile" onclick="addToWishlistMobile({{ product.id }}, this)">
                <i class="fas fa-heart"></i>
            </button>
            
            <div class="product-image-mobile">{{ product.image }}</div>
            <h6 class="product-title">{{ product.name }}</h6>
            <p class="text-muted small mb-1">{{ product.category }}</p>
            <p class="text-muted small mb-2">{{ product.description[:60] }}...</p>
            
            <div class="d-flex justify-content-between align-items-center mb-2">
                <span class="h6 text-primary mb-0">${{ "%.2f"|format(product.price) }}</span>
                <span class="badge {% if product.stock > 10 %}bg-success{% elif product.stock > 0 %}bg-warning{% else %}bg-danger{% endif %}">
                    {{ product.stock }} left
                </span>
            </div>
            
            <div class="d-flex gap-2">
                <button class="btn btn-primary btn-mobile-sm flex-fill" onclick="addToCartMobile({{ product.id }})">
                    <i class="fas fa-cart-plus"></i> Add
                </button>
                <a href="{{ url_for('product_detail', product_id=product.id) }}" class="btn btn-outline-secondary btn-mobile-sm">
                    <i class="fas fa-eye"></i>
                </a>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="text-center py-5">
        <i class="fas fa-search fa-3x text-muted mb-3"></i>
        <h4>No products found</h4>
        <p class="text-muted">Try adjusting your search criteria</p>
        <a href="{{ url_for('products') }}" class="btn btn-primary btn-mobile">View All Products</a>
    </div>
    {% endif %}
</div>

<style>
.products-container-mobile {
    margin: 0 -5px;
}

.products-grid-mobile {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    padding: 0 5px;
}

@media (max-width: 480px) {
    .products-grid-mobile {
        grid-template-columns: 1fr;
    }
}

.product-title {
    font-size: 0.9rem;
    line-height: 1.2;
    height: 2.4em;
    overflow: hidden;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
}
</style>

<script>
function addToCartMobile(productId) {
    const button = event.target;
    const originalHTML = button.innerHTML;
    
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    button.disabled = true;
    
    fetch('/add_to_cart', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({product_id: productId, quantity: 1})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMobileNotification('Added to cart!', 'success');
            updateMobileCartCount();
        } else {
            showMobileNotification(data.message, 'error');
        }
    })
    .finally(() => {
        button.innerHTML = originalHTML;
        button.disabled = false;
    });
}

// Infinite scroll for mobile
let isLoading = false;
let page = 1;

window.addEventListener('scroll', function() {
    if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 500 && !isLoading) {
        loadMoreProducts();
    }
});

function loadMoreProducts() {
    // This would need backend support for pagination
    // For now, it's a placeholder for future implementation
}
</script>
{% endblock %}
